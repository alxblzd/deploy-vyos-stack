---
# VyOS Configuration Variables
# This file contains all configuration for VyOS routers managed by Ansible

# System Configuration
vyos_timezone: "UTC"
vyos_ntp_servers:
  - 0.pool.ntp.org
  - 1.pool.ntp.org

# DNS Forwarding Configuration
dns_forwarding:
  cache_size: 10000
  upstream_servers:
    - 1.1.1.1
    - 8.8.8.8
  # Listen addresses will be automatically configured based on zone IPs

# Firewall Zones Configuration
# Defines security zones for microsegmentation
firewall_zones:
  - name: wan
    description: "WAN/Internet Zone"
    default_action: drop
    interfaces:
      - "{{ wan_interface }}"

  - name: dmz
    description: "DMZ Zone - Public-facing services"
    default_action: drop
    interfaces: []  # Will be populated by interfaces with DMZ zone

  - name: trusted
    description: "Trusted Internal Network"
    default_action: accept
    interfaces: []

  - name: guest
    description: "Guest Network - Isolated"
    default_action: drop
    interfaces: []

  - name: iot
    description: "IoT Devices - Isolated"
    default_action: drop
    interfaces: []

# North-South Firewall Rules (Internal <-> WAN)
north_south_firewall_rules:
  # Trusted -> WAN: Allow all outbound
  - name: trusted-to-wan
    from_zone: trusted
    to_zone: wan
    default_action: accept
    description: "Allow trusted zone full internet access"
    rules:
      - number: 10
        action: accept
        state:
          established: enable
          related: enable
        description: "Allow established/related"

      - number: 20
        action: accept
        description: "Allow all outbound from trusted"

  # DMZ -> WAN: Allow HTTP/HTTPS only
  - name: dmz-to-wan
    from_zone: dmz
    to_zone: wan
    default_action: drop
    description: "Allow DMZ limited internet access"
    rules:
      - number: 10
        action: accept
        state:
          established: enable
          related: enable
        description: "Allow established/related"

      - number: 20
        action: accept
        protocol: tcp
        destination:
          port: "80,443"
        description: "Allow HTTP/HTTPS outbound"

      - number: 30
        action: accept
        protocol: udp
        destination:
          port: "53"
        description: "Allow DNS queries"

  # Guest -> WAN: Allow DNS, HTTP, HTTPS only
  - name: guest-to-wan
    from_zone: guest
    to_zone: wan
    default_action: drop
    description: "Allow guest limited internet access"
    rules:
      - number: 10
        action: accept
        state:
          established: enable
          related: enable
        description: "Allow established/related"

      - number: 20
        action: accept
        protocol: tcp
        destination:
          port: "80,443"
        description: "Allow HTTP/HTTPS"

      - number: 30
        action: accept
        protocol: udp
        destination:
          port: "53"
        description: "Allow DNS"

  # IoT -> WAN: Allow outbound with restrictions
  - name: iot-to-wan
    from_zone: iot
    to_zone: wan
    default_action: drop
    description: "Allow IoT limited internet access"
    rules:
      - number: 10
        action: accept
        state:
          established: enable
          related: enable
        description: "Allow established/related"

      - number: 20
        action: accept
        protocol: tcp
        destination:
          port: "80,443,8883"
        description: "Allow HTTP/HTTPS/MQTT over TLS"

      - number: 30
        action: accept
        protocol: udp
        destination:
          port: "53,123"
        description: "Allow DNS and NTP"

  # WAN -> DMZ: Allow inbound to specific services
  - name: wan-to-dmz
    from_zone: wan
    to_zone: dmz
    default_action: drop
    description: "Allow inbound to DMZ services"
    rules:
      - number: 10
        action: accept
        state:
          established: enable
          related: enable
        description: "Allow established/related"

      - number: 20
        action: drop
        state:
          invalid: enable
        description: "Drop invalid packets"

      # Add specific rules for services in DMZ as needed
      # - number: 100
      #   action: accept
      #   protocol: tcp
      #   destination:
      #     port: "80"
      #     address: "10.0.10.100"
      #   description: "Allow HTTP to web server"

# East-West Firewall Rules (Internal Zone <-> Internal Zone)
# Microsegmentation rules for lateral movement prevention
east_west_firewall_rules:
  # Trusted -> DMZ: Allow management access
  - name: trusted-to-dmz
    from_zone: trusted
    to_zone: dmz
    default_action: accept
    description: "Allow trusted to manage DMZ"
    rules:
      - number: 10
        action: accept
        state:
          established: enable
          related: enable
        description: "Allow established/related"

      - number: 20
        action: accept
        protocol: tcp
        destination:
          port: "22,80,443"
        description: "Allow SSH and web management"

      - number: 30
        action: accept
        protocol: icmp
        description: "Allow ping"

  # DMZ -> Trusted: Deny (prevent DMZ compromise from reaching internal)
  - name: dmz-to-trusted
    from_zone: dmz
    to_zone: trusted
    default_action: drop
    description: "Block DMZ access to trusted network"
    rules:
      - number: 10
        action: accept
        state:
          established: enable
          related: enable
        description: "Allow established/related only"

      - number: 20
        action: drop
        description: "Drop all other traffic"

  # Trusted -> Guest: Deny
  - name: trusted-to-guest
    from_zone: trusted
    to_zone: guest
    default_action: drop
    description: "Isolate guest from trusted"
    rules:
      - number: 10
        action: accept
        state:
          established: enable
          related: enable
        description: "Allow established/related only"

  # Guest -> Trusted: Deny
  - name: guest-to-trusted
    from_zone: guest
    to_zone: trusted
    default_action: drop
    description: "Block guest access to trusted"
    rules:
      - number: 10
        action: drop
        description: "Drop all traffic"

  # Guest -> DMZ: Deny
  - name: guest-to-dmz
    from_zone: guest
    to_zone: dmz
    default_action: drop
    description: "Block guest access to DMZ"
    rules:
      - number: 10
        action: drop
        description: "Drop all traffic"

  # Guest -> IoT: Deny
  - name: guest-to-iot
    from_zone: guest
    to_zone: iot
    default_action: drop
    description: "Isolate guest from IoT"
    rules:
      - number: 10
        action: drop
        description: "Drop all traffic"

  # IoT -> Trusted: Deny (prevent IoT device compromise)
  - name: iot-to-trusted
    from_zone: iot
    to_zone: trusted
    default_action: drop
    description: "Block IoT access to trusted"
    rules:
      - number: 10
        action: drop
        description: "Drop all traffic"

  # IoT -> DMZ: Deny
  - name: iot-to-dmz
    from_zone: iot
    to_zone: dmz
    default_action: drop
    description: "Block IoT access to DMZ"
    rules:
      - number: 10
        action: drop
        description: "Drop all traffic"

  # IoT -> Guest: Deny
  - name: iot-to-guest
    from_zone: iot
    to_zone: guest
    default_action: drop
    description: "Isolate IoT from guest"
    rules:
      - number: 10
        action: drop
        description: "Drop all traffic"

  # Trusted -> IoT: Allow management
  - name: trusted-to-iot
    from_zone: trusted
    to_zone: iot
    default_action: accept
    description: "Allow trusted to manage IoT"
    rules:
      - number: 10
        action: accept
        description: "Allow all from trusted to IoT"

# NAT Configuration
nat_source_rules:
  - rule_number: 100
    description: "NAT for all internal networks to WAN"
    outbound_interface: "{{ wan_interface }}"
    source:
      address: "10.0.0.0/8"
    translation:
      address: masquerade

# DHCP Server Configuration
dhcp_servers:
  - subnet: 10.0.10.0/24
    zone_name: dmz
    range:
      start: 10.0.10.100
      stop: 10.0.10.200
    default_router: 10.0.10.1
    dns_server:
      - 10.0.10.1
      - 1.1.1.1
    domain_name: dmz.local
    lease: 86400
    description: "DHCP for DMZ zone"

  - subnet: 10.0.20.0/24
    zone_name: trusted
    range:
      start: 10.0.20.100
      stop: 10.0.20.200
    default_router: 10.0.20.1
    dns_server:
      - 10.0.20.1
      - 1.1.1.1
    domain_name: trusted.local
    lease: 86400
    description: "DHCP for trusted zone"

  - subnet: 10.0.30.0/24
    zone_name: guest
    range:
      start: 10.0.30.100
      stop: 10.0.30.200
    default_router: 10.0.30.1
    dns_server:
      - 1.1.1.1
      - 8.8.8.8
    domain_name: guest.local
    lease: 3600
    description: "DHCP for guest zone"

  - subnet: 10.0.40.0/24
    zone_name: iot
    range:
      start: 10.0.40.100
      stop: 10.0.40.200
    default_router: 10.0.40.1
    dns_server:
      - 10.0.40.1
      - 1.1.1.1
    domain_name: iot.local
    lease: 86400
    description: "DHCP for IoT zone"

# Static DHCP Mappings (optional)
# dhcp_static_mappings:
#   - subnet: 10.0.20.0/24
#     mappings:
#       - mac: "00:11:22:33:44:55"
#         ip: 10.0.20.50
#         description: "Server 1"

# Firewall Global Options
firewall_global:
  all_ping: enable
  broadcast_ping: disable
  ip_src_route: disable
  log_martians: enable
  receive_redirects: disable
  send_redirects: enable
  source_validation: disable
  syn_cookies: enable
  twa_hazards_protection: disable

# SSH Configuration
ssh_config:
  port: 22
  disable_password_authentication: true  # CRITICAL: Password auth must be disabled for security
  # SSH keys are configured via cloud-init template
  # For emergency access, temporarily enable via VyOS console: set service ssh disable-password-authentication false
