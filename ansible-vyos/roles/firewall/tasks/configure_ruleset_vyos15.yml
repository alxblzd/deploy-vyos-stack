---
# Configure individual firewall ruleset for VyOS 1.5+
# This task is called for each ruleset (North-South and East-West)
# Note: VyOS 1.5 removed zone-policy, so we just create named rulesets
#       and apply them to interfaces in the main firewall task

- name: Create firewall name for {{ ruleset.name }}
  vyos.vyos.vyos_config:
    lines:
      - set firewall ipv4 name {{ ruleset.name }} description '{{ ruleset.description }}'
      - set firewall ipv4 name {{ ruleset.name }} default-action {{ ruleset.default_action }}
    save: false

- name: Configure firewall rules for {{ ruleset.name }}
  vyos.vyos.vyos_config:
    lines:
      - set firewall ipv4 name {{ ruleset.name }} rule {{ item.number }} action {{ item.action }}
      - set firewall ipv4 name {{ ruleset.name }} rule {{ item.number }} description '{{ item.description }}'
    save: false
  loop: "{{ ruleset.rules }}"
  when: ruleset.rules is defined

- name: Configure protocol for firewall rules in {{ ruleset.name }}
  vyos.vyos.vyos_config:
    lines:
      - set firewall ipv4 name {{ ruleset.name }} rule {{ item.number }} protocol {{ item.protocol }}
    save: false
  loop: "{{ ruleset.rules }}"
  when:
    - ruleset.rules is defined
    - item.protocol is defined

- name: Configure state tracking for firewall rules in {{ ruleset.name }}
  vyos.vyos.vyos_config:
    lines:
      - "{% if item.state.established is defined and item.state.established == 'enable' %}set firewall ipv4 name {{ ruleset.name }} rule {{ item.number }} state established{% endif %}"
      - "{% if item.state.related is defined and item.state.related == 'enable' %}set firewall ipv4 name {{ ruleset.name }} rule {{ item.number }} state related{% endif %}"
      - "{% if item.state.invalid is defined and item.state.invalid == 'enable' %}set firewall ipv4 name {{ ruleset.name }} rule {{ item.number }} state invalid{% endif %}"
    save: false
  loop: "{{ ruleset.rules }}"
  when:
    - ruleset.rules is defined
    - item.state is defined
  ignore_errors: true

- name: Configure destination port for firewall rules in {{ ruleset.name }}
  vyos.vyos.vyos_config:
    lines:
      - set firewall ipv4 name {{ ruleset.name }} rule {{ item.number }} destination port {{ item.destination.port }}
    save: false
  loop: "{{ ruleset.rules }}"
  when:
    - ruleset.rules is defined
    - item.destination is defined
    - item.destination.port is defined

- name: Configure destination address for firewall rules in {{ ruleset.name }}
  vyos.vyos.vyos_config:
    lines:
      - set firewall ipv4 name {{ ruleset.name }} rule {{ item.number }} destination address {{ item.destination.address }}
    save: false
  loop: "{{ ruleset.rules }}"
  when:
    - ruleset.rules is defined
    - item.destination is defined
    - item.destination.address is defined

# Note: In VyOS 1.5, rulesets are applied to interfaces, not zones
# The interface application is done in the main firewall/tasks/main.yml file
