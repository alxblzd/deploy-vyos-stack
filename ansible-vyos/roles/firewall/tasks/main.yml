---
# Configure Firewall for VyOS 1.5+ (Zone-Based Firewall)
# Uses proper zone-based firewall with firewall ipv4 name rulesets and firewall zone

- name: Configure firewall global options
  vyos.vyos.vyos_config:
    lines:
      - set firewall global-options all-ping {{ firewall_global.all_ping }}
      - set firewall global-options broadcast-ping {{ firewall_global.broadcast_ping }}
      - set firewall global-options ip-src-route {{ firewall_global.ip_src_route }}
      - set firewall global-options log-martians {{ firewall_global.log_martians }}
      - set firewall global-options receive-redirects {{ firewall_global.receive_redirects }}
      - set firewall global-options send-redirects {{ firewall_global.send_redirects }}
      - set firewall global-options source-validation {{ firewall_global.source_validation }}
      - set firewall global-options syn-cookies {{ firewall_global.syn_cookies }}
    save: false

- name: Configure firewall rulesets for all zones
  vyos.vyos.vyos_config:
    lines: "{{ lookup('template', 'rulesets_vyos15.j2').split('\n') | select('match', '^set ') | list }}"
    save: false

- name: Configure zones and associate rulesets
  vyos.vyos.vyos_config:
    lines: "{{ lookup('template', 'zones_vyos15.j2').split('\n') | select('match', '^set ') | list }}"
    save: false

- name: Save firewall configuration
  vyos.vyos.vyos_config:
    save: true
