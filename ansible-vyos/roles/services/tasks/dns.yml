---
# Configure DNS forwarding - All settings in single commit to avoid validation errors

- name: Build complete DNS configuration
  ansible.builtin.set_fact:
    dns_commands: |
      {% for zone in network_zones %}
      set service dns forwarding listen-address {{ zone.ip | regex_replace('/.*', '') }}
      {% endfor %}
      {% for server in dns_forwarding.upstream_servers %}
      set service dns forwarding name-server {{ server }}
      {% endfor %}
      set service dns forwarding cache-size {{ dns_forwarding.cache_size }}
      {% for zone in network_zones %}
      set service dns forwarding allow-from {{ zone.network }}
      {% endfor %}

- name: Configure DNS forwarding service
  vyos.vyos.vyos_config:
    lines: "{{ dns_commands.split('\n') | select('match', '^set ') | list }}"
    save: true
